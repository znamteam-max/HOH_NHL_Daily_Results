      - name: Resolve PT day and check NHL completeness
        id: check
        shell: python
        run: |
          import os, sys, requests
          from datetime import datetime, timedelta, date, time
          from zoneinfo import ZoneInfo
          from pathlib import Path

          API = "https://api-web.nhle.com"
          tz_pt = ZoneInfo("America/Los_Angeles")

          force = os.getenv("FORCE_PT_DATE","").strip()
          if force:
              try:
                  base_pt = date.fromisoformat(force)
              except Exception:
                  print("Invalid pt_date input, must be YYYY-MM-DD"); sys.exit(1)
          else:
              now_pt = datetime.now(tz_pt)
              base_pt = now_pt.date() if now_pt.hour >= 6 else (now_pt.date() - timedelta(days=1))

          ymd_pt = base_pt.strftime("%Y-%m-%d")
          print("PT day:", ymd_pt)

          marker_dir = Path(".posted")
          marker_dir.mkdir(parents=True, exist_ok=True)
          marker = marker_dir / f"nhl-pt-{base_pt.strftime('%Y%m%d')}.done"
          if marker.exists():
              print(f"Already posted for NHL PT {ymd_pt}, skip.")
              with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
                  fh.write("ready=false\n")
                  fh.write(f"pt_ymd={ymd_pt}\n")
              sys.exit(0)

          start_pt = datetime.combine(base_pt, time(0,0), tzinfo=tz_pt)
          end_pt   = datetime.combine(base_pt, time(23,59,59), tzinfo=tz_pt)

          def fetch_sched(d):
              url = f"{API}/v1/schedule/{d.isoformat()}"
              r = requests.get(url, timeout=25); r.raise_for_status()
              js = r.json()
              games = js.get("games")
              if games is None:
                  weeks = js.get("gameWeek") or []
                  games = []
                  for w in weeks:
                      games.extend(w.get("games") or [])
              return games or []

          raw = []
          for d in (base_pt - timedelta(days=1), base_pt):
              raw.extend(fetch_sched(d))

          def start_pt_dt(g):
              utc = g.get("startTimeUTC") or g.get("startTime")
              if not utc: return None
              return datetime.fromisoformat(utc.replace("Z","+00:00")).astimezone(tz_pt)

          games_pt = [g for g in raw if (start_pt <= (start_pt_dt(g) or end_pt+timedelta(days=1)) <= end_pt)]
          print("Games within PT window:", len(games_pt))

          def is_completed(g): 
              return (g.get("gameState","").upper() in ("FINAL","OFF"))

          all_done = bool(games_pt) and all(is_completed(g) for g in games_pt)
          print("all_completed:", all_done)

          with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
              fh.write(f"ready={'true' if all_done else 'false'}\n")
              fh.write(f"pt_ymd={ymd_pt}\n")
