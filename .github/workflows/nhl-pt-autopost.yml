name: NHL Auto Post (PT day complete)

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:
    inputs:
      pt_date:
        description: "Принудительная PT-дата YYYY-MM-DD (опционально)"
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: nhl-autopost-pt
  cancel-in-progress: true

jobs:
  autopost:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
      FORCE_PT_DATE:      ${{ github.event.inputs.pt_date }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: Resolve PT day and check NHL completeness
        id: check
        run: |
          python - << 'PY'
          import os, sys, requests
          from datetime import datetime, timedelta, date, time
          from zoneinfo import ZoneInfo
          from pathlib import Path
          API = "https://api-web.nhle.com"
          tz_pt = ZoneInfo("America/Los_Angeles")
          force = os.getenv("FORCE_PT_DATE","").strip()
          if force:
            try: base_pt = date.fromisoformat(force)
            except: print("Invalid pt_date input"); sys.exit(1)
          else:
            now_pt = datetime.now(tz_pt)
            base_pt = now_pt.date() if now_pt.hour >= 6 else (now_pt.date() - timedelta(days=1))
          ymd_pt = base_pt.strftime("%Y-%m-%d")
          print("PT day:", ymd_pt)
          marker_dir = Path(".posted"); marker_dir.mkdir(parents=True, exist_ok=True)
          marker = marker_dir / f"nhl-pt-{base_pt.strftime('%Y%m%d')}.done"
          if marker.exists():
            print(f"Already posted for NHL PT {ymd_pt}, skip.")
            with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
              fh.write("ready=false\n")
              fh.write(f"pt_ymd={ymd_pt}\n")
            sys.exit(0)
          start_pt = datetime.combine(base_pt, time(0,0), tzinfo=tz_pt)
          end_pt   = datetime.combine(base_pt, time(23,59,59), tzinfo=tz_pt)
          def fetch_sched(d):
            url = f"{API}/v1/schedule/{d.isoformat()}"; r = requests.get(url, timeout=25); r.raise_for_status()
            js = r.json(); games = js.get("games")
            if games is None:
              weeks = js.get("gameWeek") or []; games=[]
              for w in weeks: games.extend(w.get("games") or [])
            return games or []
          raw=[]
          for d in (base_pt - timedelta(days=1), base_pt): raw.extend(fetch_sched(d))
          def start_pt_dt(g):
            utc = g.get("startTimeUTC") or g.get("startTime")
            if not utc: return None
            return datetime.fromisoformat(utc.replace("Z","+00:00")).astimezone(tz_pt)
          games_pt=[g for g in raw if (dt:=start_pt_dt(g)) and start_pt <= dt <= end_pt]
          print("Games within PT window:", len(games_pt))
          def is_completed(g): return (g.get("gameState","").upper() in ("FINAL","OFF"))
          all_done = bool(games_pt) and all(is_completed(g) for g in games_pt)
          print("all_completed:", all_done)
          with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
            fh.write(f"ready={'true' if all_done else 'false'}\n")
            fh.write(f"pt_ymd={ymd_pt}\n")
          PY

      - name: Run daily results bot (spoilered)
        if: steps.check.outputs.ready == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
        run: |
          python nhl_daily_results_bot.py

      - name: Mark PT day as posted (with rebase & retry)
        if: steps.check.outputs.ready == 'true'
        run: |
          set -e
          mkdir -p .posted
          PTYMD="${{ steps.check.outputs.pt_ymd }}"
          MARK=".posted/nhl-pt-${PTYMD//-/}.done"
          echo "posted at $(date -u +'%Y-%m-%dT%H:%M:%SZ')" > "$MARK"
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          BRANCH="${GITHUB_REF_NAME:-main}"
          git add "$MARK"
          attempt=0
          until [ $attempt -ge 3 ]
          do
            git fetch origin "$BRANCH" || true
            git pull --rebase origin "$BRANCH" || true
            if git commit -m "NHL posted for PT $PTYMD"; then
              if git push origin "HEAD:$BRANCH"; then exit 0; fi
            else
              echo "Nothing to commit"; exit 0
            fi
            attempt=$((attempt+1))
            echo "Retry push ($attempt)..."
            sleep 2
          done
          echo "Failed to push marker after retries" >&2
          exit 1
