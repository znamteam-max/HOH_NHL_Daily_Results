name: NHL Bots

on:
  workflow_dispatch: {}
  schedule:
    # Отдельные посты по каждому финальному матчу: каждые 5 минут (UTC)
    - cron: "*/5 * * * *"
    # Дневной общий пост — выбери удобное время; здесь 12:30 UTC
    - cron: "30 12 * * *"

permissions:
  contents: write  # для пуша RU-кэша и/или маркера

jobs:
  single-results:
    if: github.event.schedule == '*/5 * * * *' || github.event_name == 'workflow_dispatch'
    name: Per-game final posts
    runs-on: ubuntu-latest
    concurrency:
      group: nhl-single-results
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore state cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: state
          key: nhl-single-state-${{ github.run_id }}
          restore-keys: |
            nhl-single-state-

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: Run single-result bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
          STATE_PATH: state/posted_games.json
          DRY_RUN: "0"
          DEBUG_VERBOSE: "0"
        run: |
          python nhl_single_result_bot.py

      - name: Save state cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: state
          key: nhl-single-state-${{ github.run_id }}

  daily-summary:
    if: github.event.schedule == '30 12 * * *' || github.event_name == 'workflow_dispatch'
    name: Daily summary (+ RU cache)
    runs-on: ubuntu-latest
    concurrency:
      group: nhl-daily-summary
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PT marker (skip if already posted)
        id: ptmarker
        run: |
          PYMD=$(python - <<'PY'
          from datetime import datetime, timedelta, date
          from zoneinfo import ZoneInfo
          now_pt = datetime.now(ZoneInfo("America/Los_Angeles"))
          base = now_pt.date() if now_pt.hour >= 6 else (now_pt.date() - timedelta(days=1))
          print(base.strftime("%Y%m%d"))
          PY
          )
          echo "ptymd=$PYMD" >> $GITHUB_OUTPUT
          if [ -f ".posted/nhl-pt-${PYMD}.done" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "PT marker exists, skipping daily-summary post."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python
        if: steps.ptmarker.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        if: steps.ptmarker.outputs.skip != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: Run daily results bot (spoilered)
        if: steps.ptmarker.outputs.skip != 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
          DAYS_BACK: "1"
          DAYS_FWD:  "0"
          DRY_RUN:   "0"
          DEBUG_VERBOSE: "0"
        run: |
          python nhl_daily_results_bot.py

      - name: Update RU name cache from sports.ru (optional)
        if: steps.ptmarker.outputs.skip != 'true' && hashFiles('update_ru_cache.py') != ''
        run: |
          python update_ru_cache.py || true

      - name: Commit RU cache changes (if any)
        if: steps.ptmarker.outputs.skip != 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain -- ru_map.json ru_pending.json)" ]; then
            git add ru_map.json ru_pending.json
            git commit -m "chore(cache): update RU name map"
            git push
          else
            echo "No cache changes to commit."
          fi
