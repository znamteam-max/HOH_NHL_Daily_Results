name: NHL Single Match to Telegram

on:
  workflow_dispatch:
    inputs:
      game_pk:
        description: "Прямой GAME_PK (опционально)"
        required: false
        default: ""
      date:
        description: "Дата матча YYYY-MM-DD (если не указываете game_pk)"
        required: false
        default: ""
      teams:
        description: "Пара команд, например: NSH - DET (опционально)"
        required: false
        default: ""
      tz:
        description: "IANA TZ для интерпретации date (по умолчанию UTC)"
        required: false
        default: "UTC"

jobs:
  single:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
      IN_PK:    ${{ github.event.inputs.game_pk }}
      IN_DATE:  ${{ github.event.inputs.date }}
      IN_TEAMS: ${{ github.event.inputs.teams }}
      IN_TZ:    ${{ github.event.inputs.tz }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install requests beautifulsoup4

      - name: Resolve GAME_PK if needed
        id: res
        run: |
          python - << 'PY'
          import os, sys, re, requests

          pk = (os.getenv("IN_PK") or "").strip()
          if pk:
            print(f"GAME_PK provided: {pk}")
            with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
              fh.write(f"pk={pk}\n")
            sys.exit(0)

          date_str = (os.getenv("IN_DATE") or "").strip()
          teams_raw = (os.getenv("IN_TEAMS") or "").strip()

          if not date_str or not teams_raw:
            print("Provide either game_pk OR both date and teams (e.g. '2025-11-24' + 'NSH - DET').")
            sys.exit(1)

          m = re.match(r"^\s*([A-Za-z]{2,3})\s*[-@]\s*([A-Za-z]{2,3})\s*$", teams_raw)
          if not m:
            print("Teams must look like 'NSH - DET' or 'NSH@DET'")
            sys.exit(1)
          t1, t2 = m.group(1).upper(), m.group(2).upper()

          alias = {
            "NAS":"NSH","PHX":"ARI","LA":"LAK","NJ":"NJD","TB":"TBL","SJ":"SJS",
            "LV":"VGK","MON":"MTL","WAS":"WSH","ANH":"ANA","CLS":"CBJ","UTAH":"UTA","UTA":"UTA"
          }
          t1 = alias.get(t1, t1)
          t2 = alias.get(t2, t2)

          API = "https://api-web.nhle.com"
          url = f"{API}/v1/schedule/{date_str}"
          r = requests.get(url, timeout=25); r.raise_for_status()
          js = r.json()
          games = js.get("games")
          if games is None:
            games = []
            for w in js.get("gameWeek") or []:
              games.extend(w.get("games") or [])

          def tri(g, side):
            x = g.get(f"{side}Team") or {}
            return (x.get("abbrev") or x.get("triCode") or x.get("teamAbbrev") or "").upper()

          gid = None
          for g in games:
            h = tri(g,"home"); a = tri(g,"away")
            if {h,a} == {t1,t2}:
              gid = int(g.get("id") or g.get("gameId") or g.get("gamePk") or 0)
              break

          if not gid:
            print("Game not found for provided date/teams"); sys.exit(1)

          print(f"Resolved GAME_PK: {gid}")
          with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
            fh.write(f"pk={gid}\n")
          PY

      - name: Post single match
        env:
          GAME_PK:            ${{ steps.res.outputs.pk }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "${GAME_PK}" ]; then
            echo "No GAME_PK resolved"; exit 1
          fi
          python nhl_single_result_bot.py
